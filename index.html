<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒã‚¤ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f0f4f8; color: #333; padding-bottom: 70px; }
        body.fullscreen-active { overflow: hidden; }
        .container { max-width: 600px; margin: auto; padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 1.2em; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .version-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6em; font-weight: bold; }
        
        .main-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .main-tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 9999; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; padding: 12px 0; border: none; background: none; font-size: 0.9em; color: #7f8c8d; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-btn span { font-size: 1.5em; margin-bottom: 3px; }
        .nav-btn.active { color: #27ae60; font-weight: bold; }
        .nav-btn.active span { transform: scale(1.1); }

        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-item { background: #eef2f7; padding: 10px; border-radius: 10px; text-align: center; }
        .data-value { font-size: 1.2em; font-weight: bold; color: #3498db; }
        
        #map-container { position: relative; margin-bottom: 15px; }
        #map { height: 300px; width: 100%; border-radius: 15px; border: 2px solid #ddd; z-index: 1; }
        #fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 8px 12px; background: white; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #map-container.is-fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; margin: 0; background: white; }
        #map-container.is-fullscreen #map { height: 100vh !important; border-radius: 0; border: none; }
        #map-container.is-fullscreen #fullscreen-btn { top: env(safe-area-inset-top, 40px); right: 20px; background: #e74c3c; color: white; border: none; font-size: 1.1em; }

        input[type="number"], input[type="text"], input[type="date"], input[type="password"], select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .inline-input { width: 120px; display: inline-block; text-align: right; }
        button.action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #3498db; color: white; margin-top: 10px; transition: 0.2s; }
        button.action-btn:disabled { background: #95a5a6; }
        button.save-btn { background: #27ae60; font-size: 1.1em; padding: 15px; }
        
        .route-mode-box { display: flex; gap: 10px; background: #eef2f7; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .route-mode-box label { flex: 1; text-align: center; font-weight: bold; font-size: 0.9em; cursor: pointer; padding: 5px; border-radius: 5px; border: 1px solid transparent; }
        .route-mode-box input[type="radio"] { display: none; }
        .route-mode-box input[type="radio"]:checked + span { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 2px; }

        details { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        summary { font-weight: bold; cursor: pointer; outline: none; padding: 5px 0; }
        .profile-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .meal-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; text-align: center; font-size: 0.8em; }
        .meal-grid input { padding: 5px; font-size: 1em; text-align: center; }
        .balance-box { background: #fff3cd; border: 2px solid #ffeeba; padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; }
        .balance-result { font-size: 1.3em; font-weight: bold; margin-top: 5px; }
        .result-good { color: #27ae60; } .result-bad { color: #e74c3c; }
        
        .chart-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .chart-tab-btn { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: #f0f4f8; font-size: 0.9em; }
        .chart-tab-btn.active { background: #3498db; color: white; border-color: #2980b9; font-weight: bold; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; font-size: 0.85em; }
        #wake-lock-status { font-size: 0.8em; text-align: center; padding: 5px; border-radius: 20px; margin-bottom: 10px; }
        .status-on { background: #d4edda; color: #155724; } .status-off { background: #f8d7da; color: #721c24; }

        .concierge-area { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-start; }
        .avatar-img { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; border: 3px solid #27ae60; box-shadow: 0 2px 8px rgba(0,0,0,0.15); background-color: #fff; flex-shrink: 0; }
        .bubble { position: relative; background: #fff; border-radius: 15px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; font-size: 0.9em; line-height: 1.4; border: 1px solid #e0e0e0; }
        .bubble::before { content: ''; position: absolute; top: 25px; left: -10px; border-width: 10px 10px 10px 0; border-style: solid; border-color: transparent #fff transparent transparent; z-index: 2; }
        .bubble::after { content: ''; position: absolute; top: 24px; left: -12px; border-width: 11px 11px 11px 0; border-style: solid; border-color: transparent #e0e0e0 transparent transparent; z-index: 1; }
        .concierge-controls { display: flex; gap: 5px; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px; }
        .concierge-controls select { flex: 1; padding: 6px; font-size: 0.8em; border-radius: 5px; }
        .concierge-controls button { flex: 1; padding: 6px; background: #9b59b6; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.85em; transition: 0.2s; }
        .concierge-controls button:disabled { background: #bdc3c7; }
        .ai-typing { animation: blink 1.5s infinite; color: #888; font-weight: bold; }
        @keyframes blink { 0% {opacity: 0.2;} 50% {opacity: 1;} 100% {opacity: 0.2;} }
    </style>
</head>
<body>

    <div class="container">
        <div class="concierge-area">
            <img src="avatar.png" alt="ã‚¢ãƒã‚¿ãƒ¼" class="avatar-img" onerror="this.src='https://placehold.co/75x75/e0e0e0/ffffff?text=AI'">
            <div class="bubble">
                <div id="ai-message">ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ã€Œä½“èª¿ãƒ»é£Ÿäº‹ã€ã‚¿ãƒ–ã‹ã‚‰AIè¨­å®šï¼ˆAPIã‚­ãƒ¼ï¼‰ã‚’ä¿å­˜ã™ã‚‹ã¨ã€ç§ã¨ãŠè©±ã—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã‚ˆâ™ª</div>
                <div class="concierge-controls">
                    <select id="ai-persona">
                        <option value="maid">ğŸŒ¸ å„ªã—ã„ãƒ¡ã‚¤ãƒ‰</option>
                        <option value="tsundere">ğŸ’¢ ãƒ„ãƒ³ãƒ‡ãƒ¬å¹¼é¦´æŸ“</option>
                        <option value="coach">ğŸ”¥ ç†±è¡€ã‚³ãƒ¼ãƒ</option>
                        <option value="secretary">ğŸ‘“ ã‚¯ãƒ¼ãƒ«ãªç§˜æ›¸</option>
                    </select>
                    <button onclick="getAiAdvice()" id="ai-btn">ğŸ’¬ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’èã</button>
                </div>
            </div>
        </div>

        <div id="tab-walk" class="main-tab-content active">
            <div class="card">
                <h1 id="app-title">ã‚ãªãŸã®å¥åº·ãƒ­ã‚° <span class="version-badge">v10.3</span></h1>
                <div id="wake-lock-status" class="status-off">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šOFF (ç”»é¢ã‚¿ãƒƒãƒ—)</div>
                
                <div style="background: #f0f4f8; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ç›®æ¨™ãƒ«ãƒ¼ãƒˆä½œæˆ (AIãƒŠãƒ“):</strong><br>
                    <div class="route-mode-box">
                        <label>
                            <input type="radio" name="route-mode" value="loop" checked onchange="toggleRouteMode()">
                            <span>ğŸ”„ å‘¨å›ãƒ¢ãƒ¼ãƒ‰<br><small style="font-size:0.7em;color:#777;">è·é›¢ã‚’æŒ‡å®šã—ã¦ä¸€å‘¨</small></span>
                        </label>
                        <label>
                            <input type="radio" name="route-mode" value="dest" onchange="toggleRouteMode()">
                            <span>ğŸ“ ç›®çš„åœ°ãƒ¢ãƒ¼ãƒ‰<br><small style="font-size:0.7em;color:#777;">åœ°å›³ã‚¿ãƒƒãƒ—ã§æœ€çŸ­ãƒ«ãƒ¼ãƒˆ</small></span>
                        </label>
                    </div>

                    <div id="distance-input-area" style="display: flex; gap: 10px; margin-top: 5px;">
                        <select id="goal-type" onchange="changeGoalPlaceholder()" style="flex: 1;">
                            <option value="distance">è·é›¢ (km)</option>
                            <option value="steps">æ­©æ•° (æ­©)</option>
                        </select>
                        <input type="number" id="goal-value" value="1" step="0.5" style="flex: 1;">
                    </div>

                    <button id="route-btn" class="action-btn" onclick="generateGoalRoute()">ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢</button>
                    
                    <div id="dest-hint" style="display:none; text-align:center; font-size:0.85em; color:#e74c3c; margin-top:5px; font-weight:bold;">
                        åœ°å›³ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ã—ã¦ã€ç›®çš„åœ°ï¼ˆèµ¤ã„ãƒ”ãƒ³ï¼‰ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚
                    </div>
                </div>

                <div class="data-grid">
                    <div class="data-item">ä»Šæ—¥ã®æ­©æ•°<br><span id="steps-display" class="data-value">0</span> æ­©</div>
                    <div class="data-item">ä¸ŠãŒã£ãŸéšæ•°<br><span id="stairs-display" class="data-value">0</span> éš</div>
                    <div class="data-item" style="grid-column: span 2; background: #e8f8f5;">
                        é‹å‹•ã«ã‚ˆã‚‹æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼<br><span id="calories-display" class="data-value" style="color: #16a085;">0</span> kcal