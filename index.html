<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-item { background: #eef2f7; padding: 10px; border-radius: 10px; text-align: center; }
        .data-value { font-size: 1.2em; font-weight: bold; color: #3498db; }
        .calorie-box { background: #fff3cd; border: 1px solid #ffeeba; grid-column: span 2; }
        
        select, input[type="number"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        input[type="number"] { width: 70px; }
        
        /* ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        details { background: #f0f4f8; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        summary { font-weight: bold; cursor: pointer; outline: none; }
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .profile-result { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; text-align: center; }
        
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #save-btn { background: #27ae60; color: white; }
        #route-btn { background: #3498db; color: white; margin-bottom: 10px; }
        #map { height: 300px; width: 100%; border-radius: 15px; border: 2px solid #ddd; margin-bottom: 20px; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; font-size: 0.9em; }
        #wake-lock-status { font-size: 0.8em; text-align: center; margin-bottom: 10px; padding: 5px; border-radius: 20px; }
        .status-on { background: #d4edda; color: #155724; }
        .status-off { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="card">
        <h1>é£¯å¡šæŒ‡æ®å®˜ã®å¥åº·ãƒ­ã‚°</h1>
        <div id="wake-lock-status" class="status-off">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šOFF (ç”»é¢ã‚’ã‚¿ãƒƒãƒ—)</div>

        <details open>
            <summary>âš™ï¸ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿</summary>
            <div class="profile-grid">
                <div>æ€§åˆ¥: 
                    <select id="gender-input" onchange="updateProfile()">
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>
                <div>å¹´é½¢: <input type="number" id="age-input" value="30" oninput="updateProfile()"> æ­³</div>
                <div>èº«é•·: <input type="number" id="height-input" value="170" oninput="updateProfile()"> cm</div>
                <div>ä½“é‡: <input type="number" id="weight-input" value="65" oninput="updateProfile()"> kg</div>
            </div>
            <div class="profile-result">
                <strong>BMI:</strong> <span id="bmi-display" style="color: #e74c3c;">0.0</span> 
                ï½œ <strong>åŸºç¤ä»£è¬:</strong> <span id="bmr-display" style="color: #e74c3c;">0</span> kcal
            </div>
        </details>

        <div style="margin-bottom: 15px; background: #f0f4f8; padding: 10px; border-radius: 10px;">
            <strong>ç›®æ¨™è¨­å®š:</strong><br>
            <select id="goal-type" onchange="changeGoalPlaceholder()">
                <option value="distance">è·é›¢ (km)</option>
                <option value="steps">æ­©æ•° (æ­©)</option>
            </select>
            <input type="number" id="goal-value" value="1" step="0.5">
            <button id="route-btn" onclick="generateGoalRoute()">ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º</button>
        </div>

        <div class="data-grid">
            <div class="data-item">æ­©æ•°<br><span id="steps-display" class="data-value">0</span> æ­©</div>
            <div class="data-item">éšæ®µ<br><span id="stairs-display" class="data-value">0</span> éš</div>
            <div class="data-item calorie-box">é‹å‹•æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼<br><span id="calories-display" class="data-value" style="color: #e67e22;">0</span> kcal</div>
        </div>
        
        <button id="save-btn" onclick="saveCurrentData()">ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div id="map"></div>
    
    <h2>éå»ã®å±¥æ­´</h2>
    <div id="history-list"></div>

    <script>
        // --- 1. ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ ---
        let wakeLock = null;
        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen');
                document.getElementById('wake-lock-status').innerText = "ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šON (è¨ˆæ¸¬ä¸­)";
                document.getElementById('wake-lock-status').className = "status-on";
            } catch (err) {}
        }
        document.body.addEventListener('click', requestWakeLock);

        // --- 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º ---
        const urlParams = new URLSearchParams(window.location.search);
        const steps = parseFloat(urlParams.get('steps')) || 0;
        const stairs = parseFloat(urlParams.get('stairs')) || 0;
        document.getElementById('steps-display').innerText = steps.toLocaleString();
        document.getElementById('stairs-display').innerText = stairs.toLocaleString();

        // â˜…ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨è¨ˆç®—
        function updateProfile() {
            const w = parseFloat(document.getElementById('weight-input').value) || 0;
            const h = parseFloat(document.getElementById('height-input').value) || 0;
            const a = parseFloat(document.getElementById('age-input').value) || 0;
            const g = document.getElementById('gender-input').value;

            // BMIè¨ˆç®—: ä½“é‡(kg) / (èº«é•·(m) Ã— èº«é•·(m))
            let bmi = 0;
            if (h > 0) bmi = (w / Math.pow(h / 100, 2)).toFixed(1);
            document.getElementById('bmi-display').innerText = bmi;

            // åŸºç¤ä»£è¬è¨ˆç®— (ãƒŸãƒ•ãƒªãƒ³ãƒ»ã‚»ãƒ³ãƒˆã‚¸ãƒ§ãƒ¼ãƒ«æ–¹ç¨‹å¼)
            let bmr = 0;
            if (w > 0 && h > 0 && a > 0) {
                if (g === 'male') bmr = Math.round(10 * w + 6.25 * h - 5 * a + 5);
                else bmr = Math.round(10 * w + 6.25 * h - 5 * a - 161);
            }
            document.getElementById('bmr-display').innerText = bmr;

            // æ¬¡å›é–‹ã„ãŸæ™‚ã®ãŸã‚ã«iPhoneã«è¨­å®šã‚’è¨˜æ†¶ã•ã›ã‚‹
            localStorage.setItem('userProfile', JSON.stringify({weight: w, height: h, age: a, gender: g}));

            // é‹å‹•æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã‚‚å†è¨ˆç®—
            const totalCal = Math.round((steps * w * 0.0005) + (stairs * w * 0.1));
            document.getElementById('calories-display').innerText = totalCal.toLocaleString();
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è¨˜æ†¶ã—ãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        const savedProfile = JSON.parse(localStorage.getItem('userProfile'));
        if (savedProfile) {
            document.getElementById('weight-input').value = savedProfile.weight;
            document.getElementById('height-input').value = savedProfile.height;
            document.getElementById('age-input').value = savedProfile.age;
            document.getElementById('gender-input').value = savedProfile.gender;
        }
        updateProfile(); // åˆæœŸè¨ˆç®—ã‚’å®Ÿè¡Œ

        // --- 3. ä¿å­˜æ©Ÿèƒ½ï¼ˆBMIãƒ»åŸºç¤ä»£è¬ã‚‚ä¿å­˜ï¼‰ ---
        function saveCurrentData() {
            const date = new Date().toLocaleDateString();
            const weight = document.getElementById('weight-input').value;
            const calories = document.getElementById('calories-display').innerText;
            const bmi = document.getElementById('bmi-display').innerText;
            const bmr = document.getElementById('bmr-display').innerText;

            const newData = { date, steps, stairs, weight, calories, bmi, bmr };
            let history = JSON.parse(localStorage.getItem('walkingHistory')) || [];
            const index = history.findIndex(item => item.date === date);
            if (index > -1) history[index] = newData; else history.unshift(newData);
            localStorage.setItem('walkingHistory', JSON.stringify(history));
            alert("æœ¬æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            displayHistory();
        }

        // å±¥æ­´è¡¨ç¤ºã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('walkingHistory')) || [];
            const list = document.getElementById('history-list');
            list.innerHTML = history.map(item => `
                <div class="history-item">
                    <strong style="font-size: 1.1em;">${item.date}</strong><br>
                    ğŸƒâ€â™‚ï¸ ${item.steps.toLocaleString()}æ­© / ğŸªœ ${item.stairs}éš / ğŸ”¥ é‹å‹•: ${item.calories}kcal<br>
                    âš–ï¸ ä½“é‡: ${item.weight}kg (BMI: ${item.bmi || '--'} / åŸºç¤ä»£è¬: ${item.bmr || '--'}kcal)
                </div>
            `).join('');
        }
        displayHistory();

        // --- 4. ç›®æ¨™ãƒ«ãƒ¼ãƒˆãƒ»åœ°å›³ãƒ»GPSè¿½è·¡ (å‰å›ã¨åŒã˜) ---
        function changeGoalPlaceholder() {
            const type = document.getElementById('goal-type').value;
            const input = document.getElementById('goal-value');
            if (type === 'distance') { input.value = "1"; input.step = "0.5"; } 
            else { input.value = "3000"; input.step = "500"; }
        }

        const map = L.map('map').setView([35.6812, 139.7671], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const marker = L.marker([35.6812, 139.7671]).addTo(map);
        let pathPoints = [];
        const walkingPath = L.polyline([], { color: 'red', weight: 5 }).addTo(map);
        const goalPath = L.polyline([], { color