<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒã‚¤ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f0f4f8; color: #333; padding-bottom: 70px; }
        body.fullscreen-active { overflow: hidden; }
        .container { max-width: 600px; margin: auto; padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 1.2em; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .version-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6em; font-weight: bold; }
        
        .main-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .main-tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 9999; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; padding: 12px 0; border: none; background: none; font-size: 0.9em; color: #7f8c8d; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-btn span { font-size: 1.5em; margin-bottom: 3px; }
        .nav-btn.active { color: #27ae60; font-weight: bold; }
        .nav-btn.active span { transform: scale(1.1); }

        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-item { background: #eef2f7; padding: 10px; border-radius: 10px; text-align: center; }
        .data-value { font-size: 1.2em; font-weight: bold; color: #3498db; }
        
        #map-container { position: relative; margin-bottom: 15px; }
        #map { height: 300px; width: 100%; border-radius: 15px; border: 2px solid #ddd; z-index: 1; }
        #fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 8px 12px; background: white; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #map-container.is-fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; margin: 0; background: white; }
        #map-container.is-fullscreen #map { height: 100vh !important; border-radius: 0; border: none; }
        #map-container.is-fullscreen #fullscreen-btn { top: env(safe-area-inset-top, 40px); right: 20px; background: #e74c3c; color: white; border: none; font-size: 1.1em; }

        input[type="number"], input[type="text"], input[type="date"], select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .inline-input { width: 120px; display: inline-block; text-align: right; }
        button.action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #3498db; color: white; margin-top: 10px; transition: 0.2s; }
        button.action-btn:disabled { background: #95a5a6; }
        button.save-btn { background: #27ae60; font-size: 1.1em; padding: 15px; }
        
        details { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        summary { font-weight: bold; cursor: pointer; outline: none; padding: 5px 0; }
        .profile-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .meal-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; text-align: center; font-size: 0.8em; }
        .meal-grid input { padding: 5px; font-size: 1em; text-align: center; }
        .balance-box { background: #fff3cd; border: 2px solid #ffeeba; padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; }
        .balance-result { font-size: 1.3em; font-weight: bold; margin-top: 5px; }
        .result-good { color: #27ae60; } .result-bad { color: #e74c3c; }
        
        .chart-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .chart-tab-btn { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: #f0f4f8; font-size: 0.9em; }
        .chart-tab-btn.active { background: #3498db; color: white; border-color: #2980b9; font-weight: bold; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; font-size: 0.85em; }
        #wake-lock-status { font-size: 0.8em; text-align: center; padding: 5px; border-radius: 20px; margin-bottom: 10px; }
        .status-on { background: #d4edda; color: #155724; } .status-off { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="container">
        <div id="tab-walk" class="main-tab-content active">
            <div class="card">
                <h1 id="app-title">ã‚ãªãŸã®å¥åº·ãƒ­ã‚° <span class="version-badge">v7.1</span></h1>
                <div id="wake-lock-status" class="status-off">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šOFF (ç”»é¢ã‚¿ãƒƒãƒ—)</div>
                
                <div style="background: #f0f4f8; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ç›®æ¨™ãƒ«ãƒ¼ãƒˆä½œæˆ (AIæ•£æ­©ãƒŠãƒ“):</strong><br>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <select id="goal-type" onchange="changeGoalPlaceholder()" style="flex: 1;">
                            <option value="distance">è·é›¢ (km)</option>
                            <option value="steps">æ­©æ•° (æ­©)</option>
                        </select>
                        <input type="number" id="goal-value" value="1" step="0.5" style="flex: 1;">
                    </div>
                    <button id="route-btn" class="action-btn" onclick="generateGoalRoute()">ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢</button>
                </div>

                <div class="data-grid">
                    <div class="data-item">ä»Šæ—¥ã®æ­©æ•°<br><span id="steps-display" class="data-value">0</span> æ­©</div>
                    <div class="data-item">ä¸ŠãŒã£ãŸéšæ•°<br><span id="stairs-display" class="data-value">0</span> éš</div>
                    <div class="data-item" style="grid-column: span 2; background: #e8f8f5;">
                        é‹å‹•ã«ã‚ˆã‚‹æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼<br><span id="calories-display" class="data-value" style="color: #16a085;">0</span> kcal
                    </div>
                </div>
            </div>
            
            <div id="map-container">
                <button id="fullscreen-btn" onclick="toggleFullscreen()">ğŸ—ºï¸ æ‹¡å¤§</button>
                <div id="map"></div>
            </div>
        </div>

        <div id="tab-meal" class="main-tab-content">
            <div class="card">
                <h2 style="margin-top:0;">âš–ï¸ ä½“èª¿ã¨é£Ÿäº‹ã®è¨˜éŒ²</h2>
                <details open>
                    <summary>ğŸ‘¤ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ (è‡ªå‹•è¨ˆç®—)</summary>
                    <div class="profile-row"><span>æœ¬å:</span> <input type="text" id="realname-input" class="inline-input" oninput="calcAll()" placeholder="ä¾‹: å±±ç”° å¤ªéƒ"></div>
                    <div class="profile-row"><span>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</span> <input type="text" id="nickname-input" class="inline-input" oninput="calcAll()" placeholder="ä¾‹: ãƒ¤ãƒã¡ã‚ƒã‚“"></div>
                    <div class="profile-row"><span>æ€§åˆ¥:</span> <select id="gender-input" class="inline-input" onchange="calcAll()"><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
                    <div class="profile-row"><span>ç”Ÿå¹´æœˆæ—¥:</span> <div><input type="date" id="dob-input" onchange="calcAll()" style="width:130px;"> (<span id="calc-age">--</span>æ­³)</div></div>
                    <div class="profile-row"><span>èº«é•·(cm):</span> <input type="number" id="height-input" class="inline-input" value="170" oninput="calcAll()"></div>
                    <div class="profile-row"><span>ä½“é‡(kg):</span> <input type="number" id="weight-input" class="inline-input" value="65" oninput="calcAll()"></div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #555;">
                        BMI: <strong id="bmi-display">0.0</strong> ï½œ åŸºç¤ä»£è¬: <strong id="bmr-display">0</strong> kcal
                    </div>
                </details>

                <h3 style="font-size: 1em; margin-bottom: 5px; border-bottom: 1px solid #ccc;">ğŸ½ï¸ é£Ÿäº‹è¨˜éŒ² (1æ—¥ã®åˆè¨ˆã¾ãŸã¯å„é£Ÿ)</h3>
                <details><summary>ğŸŒ… æœé£Ÿ</summary><div class="meal-grid"><div>Kcal</div><div>P(g)</div><div>F(g)</div><div>C(g)</div><div>å¡©(g)</div><input type="number" id="bf-cal" oninput="calcAll()"><input type="number" id="bf-p" oninput="calcAll()"><input type="number" id="bf-f" oninput="calcAll()"><input type="number" id="bf-c" oninput="calcAll()"><input type="number" id="bf-s" oninput="calcAll()"></div></details>
                <details><summary>â˜€ï¸ æ˜¼é£Ÿ</summary><div class="meal-grid"><div>Kcal</div><div>P(g)</div><div>F(g)</div><div>C(g)</div><div>å¡©(g)</div><input type="number" id="lu-cal" oninput="calcAll()"><input type="number" id="lu-p" oninput="calcAll()"><input type="number" id="lu-f" oninput="calcAll()"><input type="number" id="lu-c" oninput="calcAll()"><input type="number" id="lu-s" oninput="calcAll()"></div></details>
                <details><summary>ğŸŒ™ å¤•é£Ÿ</summary><div class="meal-grid"><div>Kcal</div><div>P(g)</div><div>F(g)</div><div>C(g)</div><div>å¡©(g)</div><input type="number" id="dn-cal" oninput="calcAll()"><input type="number" id="dn-p" oninput="calcAll()"><input type="number" id="dn-f" oninput="calcAll()"><input type="number" id="dn-c" oninput="calcAll()"><input type="number" id="dn-s" oninput="calcAll()"></div></details>
                <details><summary>â˜•ï¸ é–“é£Ÿ</summary><div class="meal-grid"><div>Kcal</div><div>P(g)</div><div>F(g)</div><div>C(g)</div><div>å¡©(g)</div><input type="number" id="sn-cal" oninput="calcAll()"><input type="number" id="sn-p" oninput="calcAll()"><input type="number" id="sn-f" oninput="calcAll()"><input type="number" id="sn-c" oninput="calcAll()"><input type="number" id="sn-s" oninput="calcAll()"></div></details>

                <div style="background: #fdfefe; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px; margin-top: 10px; font-size: 0.9em;">
                    <strong>ğŸ“‹ æœ¬æ—¥ã®æ‘‚å–åˆè¨ˆ</strong><br>
                    <span id="total-kcal" style="font-size:1.2em; font-weight:bold; color:#d35400;">0</span> kcal<br>
                    P: <span id="total-p">0</span>g / F: <span id="total-f">0</span>g / C: <span id="total-c">0</span>g / å¡©åˆ†: <span id="total-s">0</span>g
                </div>
                <div class="balance-box">
                    ğŸ”¥ <strong>ä»Šæ—¥ã®ã‚«ãƒ­ãƒªãƒ¼åæ”¯</strong><br>
                    <small>æ‘‚å– <span id="bal-in">0</span> - æ¶ˆè²»(åŸºç¤<span id="bal-bmr">0</span>+é‹å‹•<span id="bal-act">0</span>)</small>
                    <div id="balance-result" class="balance-result">---</div>
                </div>
                <button class="action-btn save-btn" onclick="saveCurrentData()">ğŸ’¾ ä»Šæ—¥ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
            </div>
        </div>

        <div id="tab-history" class="main-tab-content">
            <div class="card">
                <h2 style="margin-top:0;">ğŸ“Š ã‚«ãƒ©ãƒ€ã®å¤‰åŒ–ã‚°ãƒ©ãƒ•</h2>
                <div class="chart-tabs">
                    <button id="tab-weight" class="chart-tab-btn active" onclick="switchGraph('weight')">ä½“é‡</button>
                    <button id="tab-bmi" class="chart-tab-btn" onclick="switchGraph('bmi')">BMI</button>
                    <button id="tab-bmr" class="chart-tab-btn" onclick="switchGraph('bmr')">åŸºç¤ä»£è¬</button>
                </div>
                <div style="background: white; padding: 5px; border-radius: 10px; border: 1px solid #ddd;">
                    <canvas id="healthChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 style="margin-top:0;">ğŸ—“ï¸ éå»ã®å±¥æ­´</h2>
                <div id="history-list"></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" id="nav-walk" onclick="switchMainTab('walk')"><span>ğŸš¶â€â™‚ï¸</span>æ­©è¡Œãƒ»åœ°å›³</button>
        <button class="nav-btn" id="nav-meal" onclick="switchMainTab('meal')"><span>âš–ï¸</span>ä½“èª¿ãƒ»é£Ÿäº‹</button>
        <button class="nav-btn" id="nav-history" onclick="switchMainTab('history')"><span>ğŸ“Š</span>å±¥æ­´ãƒ»ã‚°ãƒ©ãƒ•</button>
    </nav>

    <script>
        const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjBiNWMzYjRiODBlNTQxYjY4NmIwMTQ2MTIzNmYwNmFhIiwiaCI6Im11cm11cjY0In0=";

        let steps = 0, stairs = 0, activeCal = 0;
        let myChart = null;
        window.currentGraphMode = 'weight';
        let isFullscreen = false;

        window.onload = function() {
            window.switchMainTab = function(tabName) {
                document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');
                document.getElementById('nav-' + tabName).classList.add('active');
                if(tabName === 'walk' && window.map) { setTimeout(() => { window.map.invalidateSize(); }, 100); }
            };

            window.toggleFullscreen = function() {
                const container = document.getElementById('map-container');
                const btn = document.getElementById('fullscreen-btn');
                isFullscreen = !isFullscreen;
                if (isFullscreen) {
                    container.classList.add('is-fullscreen'); document.body.classList.add('fullscreen-active'); btn.innerText = "âŒ é–‰ã˜ã‚‹";
                } else {
                    container.classList.remove('is-fullscreen'); document.body.classList.remove('fullscreen-active'); btn.innerText = "ğŸ—ºï¸ æ‹¡å¤§";
                }
                setTimeout(() => { if(window.map) window.map.invalidateSize(); }, 300);
            };

            try {
                window.requestWakeLock = async function() {
                    try { 
                        let wakeLock = await navigator.wakeLock.request('screen');
                        document.getElementById('wake-lock-status').innerText = "ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šON (è¨ˆæ¸¬ä¸­)";
                        document.getElementById('wake-lock-status').className = "status-on";
                    } catch (err) {}
                };
                document.body.addEventListener('click', requestWakeLock);
                const urlParams = new URLSearchParams(window.location.search);
                steps = parseFloat(urlParams.get('steps')) || 0; stairs = parseFloat(urlParams.get('stairs')) || 0;
                document.getElementById('steps-display').innerText = steps.toLocaleString();
                document.getElementById('stairs-display').innerText = stairs.toLocaleString();
            } catch(e) {}

            window.calcAll = function() {
                try {
                    const real = document.getElementById('realname-input').value;
                    const nick = document.getElementById('nickname-input').value;
                    let displayName = "ã‚ãªãŸ";
                    if (nick) displayName = nick; else if (real) displayName = real;
                    document.getElementById('app-title').innerHTML = `${displayName}ã®å¥åº·ãƒ­ã‚° <span class="version-badge">v7.1</span>`;

                    const w = parseFloat(document.getElementById('weight-input').value) || 0;
                    const h = parseFloat(document.getElementById('height-input').value) || 0;
                    const g = document.getElementById('gender-input').value;
                    const dobStr = document.getElementById('dob-input').value;
                    let a = 0;
                    if (dobStr) {
                        const dob = new Date(dobStr); const today = new Date();
                        a = today.getFullYear() - dob.getFullYear();
                        if (today.getMonth() - dob.getMonth() < 0 || (today.getMonth() - dob.getMonth() === 0 && today.getDate() < dob.getDate())) a--;
                        document.getElementById('calc-age').innerText = a;
                    }
                    let bmi = 0; if (h > 0) bmi = (w / Math.pow(h / 100, 2)).toFixed(1);
                    document.getElementById('bmi-display').innerText = bmi;
                    let bmr = 0;
                    if (w > 0 && h > 0 && a > 0) bmr = (g === 'male') ? Math.round(10*w + 6.25*h - 5*a + 5) : Math.round(10*w + 6.25*h - 5*a - 161);
                    document.getElementById('bmr-display').innerText = bmr;
                    
                    activeCal = Math.round((steps * w * 0.0005) + (stairs * w * 0.1));
                    document.getElementById('calories-display').innerText = activeCal.toLocaleString();

                    const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
                    const tCal = getVal('bf-cal') + getVal('lu-cal') + getVal('dn-cal') + getVal('sn-cal');
                    const tP = getVal('bf-p') + getVal('lu-p') + getVal('dn-p') + getVal('sn-p');
                    const tF = getVal('bf-f') + getVal('lu-f') + getVal('dn-f') + getVal('sn-f');
                    const tC = getVal('bf-c') + getVal('lu-c') + getVal('dn-c') + getVal('sn-c');
                    const tS = getVal('bf-s') + getVal('lu-s') + getVal('dn-s') + getVal('sn-s');

                    document.getElementById('total-kcal').innerText = tCal.toLocaleString();
                    document.getElementById('total-p').innerText = tP.toFixed(1);
                    document.getElementById('total-f').innerText = tF.toFixed(1);
                    document.getElementById('total-c').innerText = tC.toFixed(1);
                    document.getElementById('total-s').innerText = tS.toFixed(1);

                    document.getElementById('bal-in').innerText = tCal;
                    document.getElementById('bal-bmr').innerText = bmr;
                    document.getElementById('bal-act').innerText = activeCal;
                    
                    const balance = tCal - (bmr + activeCal);
                    const balDiv = document.getElementById('balance-result');
                    if(bmr === 0) { balDiv.innerHTML = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; balDiv.className = "balance-result"; }
                    else if (balance > 200) { balDiv.innerHTML = `âš ï¸ ï¼‹${balance} kcal (ã‚«ãƒ­ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼!)`; balDiv.className = "balance-result result-bad"; }
                    else if (balance < -500) { balDiv.innerHTML = `âš ï¸ ${balance} kcal (é£Ÿã¹ãªã•ã™ã!)`; balDiv.className = "balance-result result-bad"; }
                    else { balDiv.innerHTML = `âœ¨ ${balance > 0 ? 'ï¼‹'+balance : balance} kcal (è¶…é©æ­£ãƒšãƒ¼ã‚¹!)`; balDiv.className = "balance-result result-good"; }

                    const cm = { bf: [getVal('bf-cal'), getVal('bf-p'), getVal('bf-f'), getVal('bf-c'), getVal('bf-s')], lu: [getVal('lu-cal'), getVal('lu-p'), getVal('lu-f'), getVal('lu-c'), getVal('lu-s')], dn: [getVal('dn-cal'), getVal('dn-p'), getVal('dn-f'), getVal('dn-c'), getVal('dn-s')], sn: [getVal('sn-cal'), getVal('sn-p'), getVal('sn-f'), getVal('sn-c'), getVal('sn-s')] };
                    localStorage.setItem('userProfileV6', JSON.stringify({realname: real, nickname: nick, weight: w, height: h, dob: dobStr, gender: g, meals: cm}));
                } catch(e) {}
            };

            try {
                const savedStr = localStorage.getItem('userProfileV6') || localStorage.getItem('userProfileV4') || localStorage.getItem('userProfileV2');
                if (savedStr) {
                    const sp = JSON.parse(savedStr);
                    if (sp.realname) document.getElementById('realname-input').value = sp.realname;
                    if (sp.nickname) document.getElementById('nickname-input').value = sp.nickname;
                    if (sp.weight) document.getElementById('weight-input').value = sp.weight;
                    if (sp.height) document.getElementById('height-input').value = sp.height;
                    if (sp.gender) document.getElementById('gender-input').value = sp.gender;
                    if (sp.dob) document.getElementById('dob-input').value = sp.dob;
                    if (sp.meals) {
                        const sv = (p, a) => { if(a[0]) document.getElementById(p+'-cal').value = a[0]; if(a[1]) document.getElementById(p+'-p').value = a[1]; if(a[2]) document.getElementById(p+'-f').value = a[2]; if(a[3]) document.getElementById(p+'-c').value = a[3]; if(a[4]) document.getElementById(p+'-s').value = a[4]; };
                        sv('bf', sp.meals.bf); sv('lu', sp.meals.lu); sv('dn', sp.meals.dn); sv('sn', sp.meals.sn);
                    }
                }
            } catch(e) {}
            calcAll();

            window.renderGraph = function() {
                try {
                    let history = JSON.parse(localStorage.getItem('walkingHistory')) || [];
                    let graphData = [...history].reverse(); let labels = graphData.map(item => item.date);
                    let dataPoints = [], lineColor = "", labelName = "";
                    if (window.currentGraphMode === 'weight') { dataPoints = graphData.map(i => parseFloat(i.weight)||0); labelName = "ä½“é‡(kg)"; lineColor = "#3498db"; }
                    else if (window.currentGraphMode === 'bmi') { dataPoints = graphData.map(i => parseFloat(i.bmi)||0); labelName = "BMI"; lineColor = "#9b59b6"; }
                    else if (window.currentGraphMode === 'bmr') { dataPoints = graphData.map(i => parseFloat(i.bmr)||0); labelName = "åŸºç¤ä»£è¬"; lineColor = "#e67e22"; }
                    const ctx = document.getElementById('healthChart').getContext('2d');
                    if (myChart) myChart.destroy();
                    myChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: labelName, data: dataPoints, borderColor: lineColor, backgroundColor: lineColor, borderWidth: 2, tension: 0, pointRadius: 4, pointBackgroundColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
                } catch(e) {}
            };
            window.switchGraph = function(mode) { window.currentGraphMode = mode; document.querySelectorAll('.chart-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + mode).classList.add('active'); renderGraph(); };

            window.saveCurrentData = function() {
                try {
                    const date = new Date().toLocaleDateString();
                    const newData = { date, steps, stairs, weight: document.getElementById('weight-input').value, calories: activeCal, bmi: document.getElementById('bmi-display').innerText, bmr: document.getElementById('bmr-display').innerText, inCal: document.getElementById('total-kcal').innerText, p: document.getElementById('total-p').innerText, f: document.getElementById('total-f').innerText, c: document.getElementById('total-c').innerText, s: document.getElementById('total-s').innerText, balance: document.getElementById('balance-result').innerText };
                    let history = JSON.parse(localStorage.getItem('walkingHistory')) || [];
                    const index = history.findIndex(item => item.date === date);
                    if (index > -1) history[index] = newData; else history.unshift(newData);
                    localStorage.setItem('walkingHistory', JSON.stringify(history));
                    alert("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼"); displayHistory(); renderGraph();
                } catch(e) {}
            };

            window.displayHistory = function() {
                try {
                    let history = JSON.parse(localStorage.getItem('walkingHistory')) || [];
                    document.getElementById('history-list').innerHTML = history.map(item => `<div class="history-item"><strong style="font-size: 1.1em; color:#2c3e50;">${item.date}</strong><br>ğŸš¶â€â™‚ï¸ ${Number(item.steps||0).toLocaleString()}æ­© / ğŸ”¥ é‹å‹•æ¶ˆè²»: ${item.calories||0}kcal<br>ğŸ½ï¸ æ‘‚å–: ${item.inCal||0}kcal (P:${item.p||0} F:${item.f||0} C:${item.c||0})<br>âš–ï¸ ä½“é‡: ${item.weight||'--'}kg / ğŸ“ˆ åæ”¯: <strong>${item.balance||'--'}</strong></div>`).join('');
                } catch(e) {}
            };
            displayHistory(); renderGraph();

            window.changeGoalPlaceholder = function() {
                const type = document.getElementById('goal-type').value;
                const input = document.getElementById('goal-value');
                if (type === 'distance') { input.value = "1"; input.step = "0.5"; } else { input.value = "3000"; input.step = "500"; }
            };

            try {
                window.map = L.map('map').setView([35.6812, 139.7671], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                const marker = L.marker([35.6812, 139.7671]).addTo(map);
                let pathPoints = [];
                const walkingPath = L.polyline([], { color: 'red', weight: 5 }).addTo(map);
                const goalPath = L.polyline([], { color: '#2980b9', weight: 6, opacity: 0.8 }).addTo(map);

                let currentLat = 35.6812; let currentLng = 139.7671;

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(p => {
                        currentLat = p.coords.latitude; currentLng = p.coords.longitude;
                        const pos = [currentLat, currentLng];
                        map.setView(pos); marker.setLatLng(pos);
                        pathPoints.push(pos); walkingPath.setLatLngs(pathPoints);
                    }, null, { enableHighAccuracy: true });
                }

                window.generateGoalRoute = async function() {
                    const btn = document.getElementById('route-btn');
                    const type = document.getElementById('goal-type').value;
                    const value = parseFloat(document.getElementById('goal-value').value);
                    if (!value || value <= 0) return;
                    
                    btn.innerText = "é€šä¿¡ä¸­... (AIæ•£æ­©ãƒŠãƒ“è¨ˆç®—ä¸­)";
                    btn.disabled = true;

                    let distMeters = (type === 'distance' ? value : value * 0.0007) * 1000;
                    const randomSeed = Math.floor(Math.random() * 10000);

                    try {
                        // â˜… v7.1: ã“ã“ã‚’ foot-hiking ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚è£é“ã‚„å…¬åœ’ãŒé¸ã°ã‚Œã‚„ã™ããªã‚Šã¾ã™ï¼
                        const response = await fetch('https://api.openrouteservice.org/v2/directions/foot-hiking/geojson', {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8',
                                'Content-Type': 'application/json',
                                'Authorization': ORS_API_KEY
                            },
                            body: JSON.stringify({
                                coordinates: [[currentLng, currentLat]],
                                options: {
                                    round_trip: {
                                        length: distMeters,
                                        points: 3,
                                        seed: randomSeed
                                    }
                                }
                            })
                        });

                        if (!response.ok) {
                            alert("ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å†æ¤œç´¢ã—ã¾ã™ï¼");
                            btn.innerText = "ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢";
                            btn.disabled = false;
                            return;
                        }

                        const data = await response.json();
                        const routeCoords = data.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        goalPath.setLatLngs(routeCoords);
                        map.fitBounds(goalPath.getBounds());
                        
                        const actualDist = (data.features[0].properties.summary.distance / 1000).toFixed(2);
                        const actualMins = Math.round(data.features[0].properties.summary.duration / 60);
                        
                        alert(`æ•£æ­©é“ã«æ²¿ã£ãŸç´„${actualDist}km (å¾’æ­©ç´„${actualMins}åˆ†) ã®å‘¨å›ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼`);

                    } catch(err) {
                        console.error(err);
                        alert("é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    } finally {
                        btn.innerText = "ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢";
                        btn.disabled = false;
                    }
                };
            } catch(e) {}
        };
    </script>
</body>
</html>