<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイウォーキングアプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-item { background: #eef2f7; padding: 10px; border-radius: 10px; text-align: center; }
        .data-value { font-size: 1.2em; font-weight: bold; color: #3498db; }
        .calorie-box { background: #fff3cd; border: 1px solid #ffeeba; grid-column: span 2; }
        
        select, input[type="number"], input[type="date"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        input[type="number"] { width: 70px; }
        
        details { background: #f0f4f8; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        summary { font-weight: bold; cursor: pointer; outline: none; }
        .profile-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; } /* スマホで見やすいように1列に変更 */
        .profile-row { display: flex; justify-content: space-between; align-items: center; }
        .profile-result { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; text-align: center; }
        
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #save-btn { background: #27ae60; color: white; }
        #route-btn { background: #3498db; color: white; margin-bottom: 10px; }
        #map { height: 300px; width: 100%; border-radius: 15px; border: 2px solid #ddd; margin-bottom: 20px; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; font-size: 0.9em; }
        #wake-lock-status { font-size: 0.8em; text-align: center; margin-bottom: 10px; padding: 5px; border-radius: 20px; }
        .status-on { background: #d4edda; color: #155724; }
        .status-off { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="card">
        <h1>飯塚指揮官の健康ログ</h1>
        <div id="wake-lock-status" class="status-off">スリープ防止：OFF (画面をタップ)</div>

        <details open>
            <summary>⚙️ パーソナルデータ</summary>
            <div class="profile-grid">
                <div class="profile-row">
                    <span>性別:</span>
                    <select id="gender-input" onchange="updateProfile()">
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                    </select>
                </div>
                <div class="profile-row">
                    <span>生年月日:</span>
                    <div>
                        <input type="date" id="dob-input" value="1990-01-01" onchange="updateProfile()">
                        <strong style="color: #2c3e50; margin-left: 5px;">(<span id="calculated-age">--</span>歳)</strong>
                    </div>
                </div>
                <div class="profile-row">
                    <span>身長:</span>
                    <div><input type="number" id="height-input" value="170" oninput="updateProfile()"> cm</div>
                </div>
                <div class="profile-row">
                    <span>体重:</span>
                    <div><input type="number" id="weight-input" value="65" oninput="updateProfile()"> kg</div>
                </div>
            </div>
            <div class="profile-result">
                <strong>BMI:</strong> <span id="bmi-display" style="color: #e74c3c;">0.0</span> 
                ｜ <strong>基礎代謝:</strong> <span id="bmr-display" style="color: #e74c3c;">0</span> kcal
            </div>
        </details>

        <div style="margin-bottom: 15px; background: #f0f4f8; padding: 10px; border-radius: 10px;">
            <strong>目標設定:</strong><br>
            <select id="goal-type" onchange="changeGoalPlaceholder()">
                <option value="distance">距離 (km)</option>
                <option value="steps">歩数 (歩)</option>
            </select>
            <input type="number" id="goal-value" value="1" step="0.5">
            <button id="route-btn" onclick="generateGoalRoute()">おすすめルートを表示</button>
        </div>

        <div class="data-grid">
            <div class="data-item">歩数<br><span id="steps-display" class="data-value">0</span> 歩</div>
            <div class="data-item">階段<br><span id="stairs-display" class="data-value">0</span> 階</div>
            <div class="data-item calorie-box">運動消費カロリー<br><span id="calories-display" class="data-value" style="color: #e67e22;">0</span> kcal</div>
        </div>
        
        <button id="save-btn" onclick="saveCurrentData()">今日の記録を保存する</button>
    </div>

    <div id="map"></div>
    
    <h2>過去の履歴</h2>
    <div id="history-list"></div>

    <script>
        try {
            // --- 1. スリープ防止 ---
            let wakeLock = null;
            async function requestWakeLock() {
                try { wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wake-lock-status').innerText = "スリープ防止：ON (計測中)";
                    document.getElementById('wake-lock-status').className = "status-on";
                } catch (err) {}
            }
            document.body.addEventListener('click', requestWakeLock);

            // --- 2. データの取得と表示 ---
            const urlParams = new URLSearchParams(window.location.search);
            const steps = parseFloat(urlParams.get('steps')) || 0;
            const stairs = parseFloat(urlParams.get('stairs')) || 0;
            document.getElementById('steps-display').innerText = steps.toLocaleString();
            document.getElementById('stairs-display').innerText = stairs.toLocaleString();

            // ★パーソナルデータの計算（年齢自動計算を含む）
            window.updateProfile = function() {
                const w = parseFloat(document.getElementById('weight-input').value) || 0;
                const h = parseFloat(document.getElementById('height-input').value) || 0;
                const g = document.getElementById('gender-input').value;
                const dobStr = document.getElementById('dob-input').value;

                // 生年月日から現在の年齢を計算
                let a = 0; // 年齢
                if (dobStr) {
                    const dob = new Date(dobStr);
                    const today = new Date();
                    a = today.getFullYear() - dob.getFullYear();
                    const m = today.getMonth() - dob.getMonth();
                    // 今年の誕生日がまだ来ていない場合は1歳引く
                    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                        a--;
                    }
                    document.getElementById('calculated-age').innerText = a;
                } else {
                    document.getElementById('calculated-age').innerText = '--';
                }

                // BMI計算
                let bmi = 0;
                if (h > 0) bmi = (w / Math.pow(h / 100, 2)).toFixed(1);
                document.getElementById('bmi-display').innerText = bmi;

                // 基礎代謝