<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; color: #333; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        /* ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã« v2.0 ã®ç›®å°ã‚’è¿½åŠ  */
        h1 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .version-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6em; font-weight: bold; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-item { background: #eef2f7; padding: 10px; border-radius: 10px; text-align: center; }
        .data-value { font-size: 1.2em; font-weight: bold; color: #3498db; }
        .calorie-box { background: #fff3cd; border: 1px solid #ffeeba; grid-column: span 2; }
        select, input[type="number"], input[type="date"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        input[type="number"] { width: 70px; }
        details { background: #f0f4f8; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        summary { font-weight: bold; cursor: pointer; outline: none; }
        .profile-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .profile-row { display: flex; justify-content: space-between; align-items: center; }
        .profile-result { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; text-align: center; }
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #save-btn { background: #27ae60; color: white; }
        #route-btn { background: #3498db; color: white; margin-bottom: 10px; }
        #map { height: 300px; width: 100%; border-radius: 15px; border: 2px solid #ddd; margin-bottom: 20px; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; font-size: 0.9em; }
        #wake-lock-status { font-size: 0.8em; text-align: center; margin-bottom: 10px; padding: 5px; border-radius: 20px; }
        .status-on { background: #d4edda; color: #155724; }
        .status-off { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="card">
        <h1>é£¯å¡šæŒ‡æ®å®˜ã®å¥åº·ãƒ­ã‚° <span class="version-badge">v2.0</span></h1>
        <div id="wake-lock-status" class="status-off">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šOFF (ç”»é¢ã‚’ã‚¿ãƒƒãƒ—)</div>

        <details open>
            <summary>âš™ï¸ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿</summary>
            <div class="profile-grid">
                <div class="profile-row">
                    <span>æ€§åˆ¥:</span>
                    <select id="gender-input" onchange="updateProfile()">
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>
                <div class="profile-row">
                    <span>ç”Ÿå¹´æœˆæ—¥:</span>
                    <div>
                        <input type="date" id="dob-input" value="1990-01-01" onchange="updateProfile()">
                        <strong style="color: #2c3e50; margin-left: 5px;">(<span id="calculated-age">--</span>æ­³)</strong>
                    </div>
                </div>
                <div class="profile-row">
                    <span>èº«é•·:</span>
                    <div><input type="number" id="height-input" value="170" oninput="updateProfile()"> cm</div>
                </div>
                <div class="profile-row">
                    <span>ä½“é‡:</span>
                    <div><input type="number" id="weight-input" value="65" oninput="updateProfile()"> kg</div>
                </div>
            </div>
            <div class="profile-result">
                <strong>BMI:</strong> <span id="bmi-display" style="color: #e74c3c;">0.0</span> 
                ï½œ <strong>åŸºç¤ä»£è¬:</strong> <span id="bmr-display" style="color: #e74c3c;">0</span> kcal
            </div>
        </details>

        <div style="margin-bottom: 15px; background: #f0f4f8; padding: 10px; border-radius: 10px;">
            <strong>ç›®æ¨™è¨­å®š:</strong><br>
            <select id="goal-type" onchange="changeGoalPlaceholder()">
                <option value="distance">è·é›¢ (km)</option>
                <option value="steps">æ­©æ•° (æ­©)</option>
            </select>
            <input type="number" id="goal-value" value="1" step="0.5">
            <button id="route-btn" onclick="generateGoalRoute()">ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º</button>
        </div>

        <div class="data-grid">
            <div class="data-item">æ­©æ•°<br><span id="steps-display" class="data-value">0</span> æ­©</div>
            <div class="data-item">éšæ®µ<br><span id="stairs-display" class="data-value">0</span> éš</div>
            <div class="data-item calorie-box">é‹å‹•æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼<br><span id="calories-display" class="data-value" style="color: #e67e22;">0</span> kcal</div>
        </div>
        
        <button id="save-btn" onclick="saveCurrentData()">ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div id="map"></div>
    
    <h2>éå»ã®å±¥æ­´</h2>
    <div id="history-list"></div>

    <script>
        // ã‚¨ãƒ©ãƒ¼ã®é€£é–ã‚’å®Œå…¨ã«é˜²ãç‹¬ç«‹è¨­è¨ˆ
        let steps = 0;
        let stairs = 0;

        window.onload = function() {
            // 1. ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢
            try {
                window.requestWakeLock = async function() {
                    try { 
                        let wakeLock = await navigator.wakeLock.request('screen');
                        document.getElementById('wake-lock-status').innerText = "ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼šON (è¨ˆæ¸¬ä¸­)";
                        document.getElementById('wake-lock-status').className = "status-on";
                    } catch (err) {}
                };
                document.body.addEventListener('click', requestWakeLock);
            } catch(e) {}

            // 2. æ­©æ•°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š
            try {
                const urlParams = new URLSearchParams(window.location.search);
                steps = parseFloat(urlParams.get('steps')) || 0;
                stairs = parseFloat(urlParams.get('stairs')) || 0;
                document.getElementById('steps-display').innerText = steps.toLocaleString();
                document.getElementById('stairs-display').innerText = stairs.toLocaleString();
            } catch(e) {}

            // 3. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
            window.updateProfile = function() {
                try {
                    const w = parseFloat(document.getElementById('weight-input').value) || 0;
                    const h = parseFloat(document.getElementById('height-input').value) || 0;
                    const g = document.getElementById('gender-input').value;
                    const dobStr = document.getElementById('dob-input').value;

                    let a = 0;
                    if (dobStr) {
                        const dob = new Date(dobStr);
                        const today = new Date();
                        a = today.getFullYear() - dob.getFullYear();
                        const m = today.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                            a--;
                        }
                        document.getElementById('calculated-age').innerText = a;
                    } else {
                        document.getElementById('calculated-age').innerText = '--';
                    }

                    let bmi = 0;
                    if (h > 0) bmi = (w / Math.pow(h / 100, 2)).toFixed(1);
                    document.getElementById('bmi-display').innerText = bmi;

                    let bmr = 0;
                    if (w > 0 && h > 0 && a > 0) {
                        if (g === 'male') bmr = Math.round(10 * w + 6.25 * h - 5 * a + 5);
                        else bmr = Math.round(10 * w + 6.25 * h - 5 * a - 161);
                    }
                    document.getElementById('bmr-display').innerText = bmr;

                    localStorage.setItem('userProfileV2', JSON.stringify({weight: w, height: h, dob: dobStr, gender: g}));
                    const totalCal = Math.round((steps * w * 0.0005) + (stairs * w * 0.1));
                    document.getElementById('calories-display').innerText = totalCal.toLocaleString();
                } catch(e) { console.error(e); }
            };

            // 4. ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
            try {
                // ã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã£ã¦ã„ãŸå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¨ã¦ã¦ã€V2ç”¨ã®æ–°ã—ã„ç®±ã‚’ä½¿ã„ã¾ã™
                const savedStr = localStorage.getItem('userProfileV2');
                if (savedStr) {
                    const savedProfile = JSON.parse(savedStr);
                    if (savedProfile.weight) document.getElementById('weight-input').value = savedProfile.weight;
                    if (savedProfile.height) document.getElementById('height-input').value = savedProfile.height;
                    if (savedProfile.gender) document.getElementById('gender-input').value = savedProfile.gender;
                    if (savedProfile.dob) document.getElementById('dob-input').value = savedProfile.dob;
                }
            } catch(e) {}
            updateProfile();

            // 5. å±¥æ­´æ©Ÿèƒ½
            window.saveCurrentData = function() {
                try {
                    const date = new Date().toLocaleDateString();
                    const weight = document.getElementById('weight-input').value;
                    const calories = document.getElementById('calories-display').innerText;
                    const bmi = document.getElementById('bmi-display').innerText;
                    const bmr = document.getElementById('bmr-display').innerText;

                    const newData = { date, steps, stairs, weight, calories, bmi, bmr };
                    let history = [];
                    try { history = JSON.parse(localStorage.getItem('walkingHistory')) || []; } catch(e){}
                    
                    const index = history.findIndex(item => item.date === date);
                    if (index > -1) history[index] = newData; else history.unshift(newData);
                    
                    localStorage.setItem('walkingHistory', JSON.stringify(history));
                    alert("æœ¬æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
                    displayHistory();
                } catch(e) {}
            };

            window.displayHistory = function() {
                try {
                    let history = [];
                    try { history = JSON.parse(localStorage.getItem('walkingHistory')) || []; } catch(e){}
                    const list = document.getElementById('history-list');
                    list.innerHTML = history.map(item => {
                        return `
                        <div class="history-item">
                            <strong style="font-size: 1.1em;">${item.date}</strong><br>
                            ğŸƒâ€â™‚ï¸ ${Number(item.steps||0).toLocaleString()}æ­© / ğŸªœ ${item.stairs||0}éš / ğŸ”¥ é‹å‹•: ${item.calories||0}kcal<br>
                            âš–ï¸ ä½“é‡: ${item.weight||'--'}kg (BMI: ${item.bmi||'--'} / åŸºç¤ä»£è¬: ${item.bmr||'--'}kcal)
                        </div>
                        `;
                    }).join('');
                } catch(e) {}
            };
            displayHistory();

            // 6. åœ°å›³ã¨ç›®æ¨™ãƒ«ãƒ¼ãƒˆ
            window.changeGoalPlaceholder = function() {
                const type = document.getElementById('goal-type').value;
                const input = document.getElementById('goal-value');
                if (type === 'distance') { input.value = "1"; input.step = "0.5"; } 
                else { input.value = "3000"; input.step = "500"; }
            };

            try {
                const map = L.map('map').setView([35.6812, 139.7671], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                const marker = L.marker([35.6812, 139.7671]).addTo(map);
                let pathPoints = [];
                const walkingPath = L.polyline([], { color: 'red', weight: 5 }).addTo(map);
                const goalPath = L.polyline([], { color: '#3498db', weight: 4, dashArray: '10, 10', opacity: 0.7 }).addTo(map);

                let currentLat = 35.6812; let currentLng = 139.7671;

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(p => {
                        currentLat = p.coords.latitude; currentLng = p.coords.longitude;
                        const pos = [currentLat, currentLng];
                        map.setView(pos); marker.setLatLng(pos);
                        pathPoints.push(pos); walkingPath.setLatLngs(pathPoints);
                    }, null, { enableHighAccuracy: true });
                }

                window.generateGoalRoute = function() {
                    const type = document.getElementById('goal-type').value;
                    const value = parseFloat(document.getElementById('goal-value').value);
                    if (!value || value <= 0) return;
                    let dist = type === 'distance' ? value : value * 0.0007;

                    const side = dist / 4; 
                    const latDiff = side / 111;
                    const lngDiff = side / (111 * Math.cos(currentLat * Math.PI / 180));
                    const p1 = [currentLat, currentLng]; const p2 = [currentLat + latDiff, currentLng];
                    const p3 = [currentLat + latDiff, currentLng + lngDiff]; const p4 = [currentLat, currentLng + lngDiff];
                    
                    goalPath.setLatLngs([p1, p2, p3, p4, p1]);
                    map.fitBounds(goalPath.getBounds());
                };
            } catch(e) {}
        };
    </script>
</body>
</html>